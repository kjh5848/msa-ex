# ğŸ“š ì›¹ì†Œì¼“ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê°€ì´ë“œ: Local vs EKS

EKS(í´ë¼ìš°ë“œ) í™˜ê²½ì—ì„œ ì›¹ì†Œì¼“ í†µì‹  ì‹œ ë°œìƒí–ˆë˜ íƒ€ì´ë° ì´ìŠˆì™€ ì´ì— ëŒ€í•œ ê¸°ìˆ ì  í•´ê²° ë°©ë²•ì„ ì •ë¦¬í•œ ë¬¸ì„œì…ë‹ˆë‹¤.

---

## 1. ì›¹ì†Œì¼“ ì—°ê²° (Connection Timing) ì°¨ì´

### ğŸ“ í˜„ìƒ
ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” ì˜ ëŒì•„ê°€ë˜ ì½”ë“œê°€ EKS í™˜ê²½ì—ì„œëŠ” **`InvalidStateError: The connection has not been established yet`**ì„ ë°œìƒì‹œí‚´.

### ğŸ” ì›ì¸ ë¶„ì„ (ë¡œì»¬ vs EKS)
*   **ë¡œì»¬(Localhost)**: ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì´ ê±°ì˜ ì—†ì–´ `connect()` í˜¸ì¶œ ì¦‰ì‹œ ì—°ê²°ì´ ì™„ë£Œë¨. ë‹¤ìŒ ì¤„ì˜ `fetch()`ë‚˜ `subscribe()`ê°€ ì‹¤í–‰ë  ë•Œ ì´ë¯¸ ì—°ê²°ëœ ìƒíƒœì„.
*   **EKS + NLB**: ë¬¼ë¦¬ì  ê±°ë¦¬ì™€ ë¡œë“œë°¸ëŸ°ì„œ(NLB) í†µê³¼ ì‹œê°„ìœ¼ë¡œ ì¸í•´ ì—°ê²°(`Handshake`)ì— ìˆ˜ì‹­~ìˆ˜ë°± ë°€ë¦¬ì´ˆê°€ ì†Œìš”ë¨. ì—°ê²°ì´ í™•ë¦½ë˜ê¸° ì „ì— êµ¬ë…ì„ ì‹œë„í•˜ì—¬ ì—ëŸ¬ ë°œìƒ.

### âœ… í•´ê²° ë°©ë²•
`Promise`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì—°ê²°ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ì½”ë“œ ì‹¤í–‰ì„ ëª…ì‹œì ìœ¼ë¡œ ëŒ€ê¸°(`await`)ì‹œí‚´.
```javascript
// ìˆ˜ì •í•œ ì½”ë“œ ì˜ˆì‹œ
await new Promise((resolve, reject) => {
    stomp.connect({}, resolve, reject);
});
// ì´ì œ ì•ˆì‹¬í•˜ê³  ë‹¤ìŒ ë¡œì§ ìˆ˜í–‰
```

---

## 2. ì•Œë¦¼ êµ¬ë… (Subscription Timing) ì°¨ì´

### ğŸ“ í˜„ìƒ
ì£¼ë¬¸ ìš”ì²­ì€ ì„±ê³µí–ˆìœ¼ë‚˜, ì•Œë¦¼ ë©”ì‹œì§€ê°€ í™”ë©´ì— ë‚˜íƒ€ë‚˜ì§€ ì•Šê³  ë¬´í•œ ëŒ€ê¸° ìƒíƒœì— ë¹ ì§ (ë©”ì‹œì§€ ìœ ì‹¤).

### ğŸ” ì›ì¸ ë¶„ì„ (ë¡œì»¬ vs EKS)
*   **ë¡œì»¬**: ì„œë²„ ì²˜ë¦¬ ì†ë„ë³´ë‹¤ í´ë¼ì´ì–¸íŠ¸ì˜ êµ¬ë… ì„¤ì •ì´ ìš°ì—°íˆ ë¹¨ë¼ ë©”ì‹œì§€ë¥¼ ì •ìƒ ìˆ˜ì‹ í•¨.
*   **EKS (High Speed Saga)**: ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ì™€ ì¹´í”„ì¹´ì˜ ì²˜ë¦¬ ì†ë„ê°€ ë§¤ìš° ë¹ ë¦„. ë¸Œë¼ìš°ì €ê°€ ì£¼ë¬¸ ì‘ë‹µì„ ì²˜ë¦¬í•˜ê³  êµ¬ë…ì„ ì‹œì‘í•˜ê¸° ì „ì—, ì´ë¯¸ ì„œë²„ëŠ” ì•Œë¦¼ ì „ì†¡ì„ ì™„ë£Œí•´ë²„ë¦¼ (Race Condition).

### âœ… í•´ê²° ë°©ë²•
ì£¼ë¬¸ ìš”ì²­(`fetch`)ì„ ë³´ë‚´ê¸° **ì „(Before)**ì— ë¯¸ë¦¬ êµ¬ë…ì„ ì™„ë£Œí•˜ì—¬ ëŒ€ê¸° ìƒíƒœë¥¼ ë¨¼ì € í™•ë³´í•¨.
*   **ê¸°ì¡´**: ì£¼ë¬¸ ì„±ê³µ ì‘ë‹µ í›„ êµ¬ë… (ëŠ¦ìŒ)
*   **ìˆ˜ì •**: ì›¹ì†Œì¼“ ì—°ê²° ì„±ê³µ ì§í›„ ì¦‰ì‹œ êµ¬ë… ì‹œì‘ (ì•ˆì „)

---

## 3. ì¢…í•© ë¹„êµ ìš”ì•½

| ë¹„êµ í•­ëª© | ë¡œì»¬ í™˜ê²½ (Localhost) | EKS í™˜ê²½ (NLB/Cloud) | í•´ê²° ì „ëµ |
| :--- | :--- | :--- | :--- |
| **Network Latency** | ê±°ì˜ 0 (Instant) | ë°œìƒ (30ms ~ 200ms+) | **ë¹„ë™ê¸° íë¦„ ì œì–´** |
| **Handshake ì†ë„** | ë§¤ìš° ë¹ ë¦„ | ìƒëŒ€ì ìœ¼ë¡œ ëŠë¦¼ | **Promise ëŒ€ê¸°** |
| **ë©”ì‹œì§€ ë§¤ì¹­** | íƒ€ì´ë° ì´ìŠˆê°€ ìˆ¨ê²¨ì§ | íƒ€ì´ë° ì´ìŠˆê°€ ì¦‰ê° ë…¸ì¶œë¨ | **ì‚¬ì „ êµ¬ë… ë°©ì‹** |
| **ë¡œë“œë°¸ëŸ°ì„œ ì˜í–¥** | ì—†ìŒ | NLBì˜ L4 íŒ¨í‚· ì „ë‹¬ ê³¼ì • í¬í•¨ | í”„ë¡œí† ì½œ ì•ˆì •ì„± í™•ë³´ |

---

## ğŸ’¡ ìµœì¢… ì‹¬í™” ê²°ë¡ 
í´ë¼ìš°ë“œ ë¶„ì‚° í™˜ê²½ì—ì„œëŠ” ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì´ ìƒì¡´í•˜ë¯€ë¡œ, **"ë¹„ë™ê¸° ì‘ì—…ì˜ ì™„ë£Œ ìˆœì„œ"**ë¥¼ ì‹œìŠ¤í…œì— ë§¡ê¸°ì§€ ì•Šê³  ê°œë°œìê°€ ì½”ë“œë¡œ ì§ì ‘ ì œì–´í•´ì•¼ í•©ë‹ˆë‹¤. íŠ¹íˆ ì›¹ì†Œì¼“ê³¼ ê°™ì€ ìœ ë² ëŸ´(Stateful) í†µì‹ ì—ì„œëŠ” **"ì—°ê²° -> êµ¬ë… -> ìš”ì²­"**ì˜ ìˆœì„œë¥¼ ì—„ê²©íˆ ì¤€ìˆ˜í•˜ëŠ” ê²ƒì´ MSA ì‹œìŠ¤í…œì˜ ì‹ ë¢°ì„±ì„ ê²°ì •ì§“ëŠ” í•µì‹¬ ìš”ì†Œì…ë‹ˆë‹¤.

## Mermaid ë‹¤ì´ì–´ê·¸ë¨

### Flow

```mermaid
flowchart LR
  C[Client] --> NLB[NLB]
  NLB --> WS[WebSocket Server]
  WS --> S[Subscribe]
```

### Sequence

```mermaid
sequenceDiagram
  participant C as Client
  participant WS as WebSocket

  C->>WS: connect()
  WS-->>C: connected
  C->>WS: subscribe()
  C->>WS: fetch() / order
  WS-->>C: message
```

