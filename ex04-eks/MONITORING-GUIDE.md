# ðŸ“Š MSA ëª¨ë‹ˆí„°ë§ ì‹¤ì „ ê°€ì´ë“œ (EKS)

ì´ ë¬¸ì„œëŠ” Prometheusì™€ Grafanaë¥¼ ì‚¬ìš©í•˜ì—¬ ìš°ë¦¬ê°€ êµ¬ì¶•í•œ MSA ì‹œìŠ¤í…œì˜ ìƒíƒœë¥¼ **ëˆˆìœ¼ë¡œ í™•ì¸í•˜ê³  ì¶”ì í•˜ëŠ” ë°©ë²•**ì„ ì„¤ëª…í•©ë‹ˆë‹¤. ë‹¨ìˆœížˆ "ì„œë²„ê°€ ì¼œì ¸ ìžˆë‚˜?"ë¥¼ ë„˜ì–´, **ë¡œê·¸ì¸í•˜ê³  ì£¼ë¬¸í•  ë•Œ ë‚´ë¶€ì—ì„œ ë¬´ìŠ¨ ì¼ì´ ì–´ë‚˜ëŠ”ì§€** ê·¸ëž˜í”„ë¡œ í™•ì¸í•´ë´…ì‹œë‹¤.

---

## 1. ëª¨ë‹ˆí„°ë§ ì ‘ì† ì¤€ë¹„

ëª¨ë‹ˆí„°ë§ ë„êµ¬ëŠ” ë³´ì•ˆìƒ ì™¸ë¶€(ì¸í„°ë„·)ì— ë…¸ì¶œí•˜ì§€ ì•Šê³ , ë¡œì»¬ì—ì„œ **í¬íŠ¸ í¬ì›Œë”©(Port Forwarding)**ì„ í†µí•´ ì•ˆì „í•˜ê²Œ ì ‘ì†í•©ë‹ˆë‹¤.

### 1-1. í¬íŠ¸ í¬ì›Œë”© ì‹¤í–‰
í„°ë¯¸ë„ì„ ì—´ê³  ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ ë‚´ ì»´í“¨í„°ì™€ EKS í´ëŸ¬ìŠ¤í„°ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤. (ì‹¤ìŠµí•˜ëŠ” ë™ì•ˆ í„°ë¯¸ë„ì„ ì¼œë‘ì„¸ìš”)

```powershell
# Grafana ì ‘ì† í„°ë„ ì—´ê¸° (3000ë²ˆ í¬íŠ¸)
kubectl port-forward svc/grafana -n monitoring 3000:3000
```

### 1-2. Grafana ë¡œê·¸ì¸
1. ì›¹ ë¸Œë¼ìš°ì € ì ‘ì†: [http://localhost:3000](http://localhost:3000)
2. ë¡œê·¸ì¸ ì •ë³´:
   - **ID**: `admin`
   - **PW**: `admin` (ì²« ë¡œê·¸ì¸ ì‹œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ìš”ì²­ì´ ëœ¨ë©´ `Skip` í•˜ì…”ë„ ë©ë‹ˆë‹¤)

### 1-3. ë°ì´í„°ì†ŒìŠ¤ í™•ì¸
1. ì™¼ìª½ ë©”ë‰´ **Connections** (í”ŒëŸ¬ê·¸ ì•„ì´ì½˜) -> **Data sources** í´ë¦­.
2. `Prometheus`ê°€ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìžˆì–´ì•¼ í•©ë‹ˆë‹¤. (ìš°ë¦¬ê°€ ConfigMapìœ¼ë¡œ ìžë™ ë“±ë¡í•´ë‘ )
3. í´ë¦­í•´ì„œ ë§¨ ì•„ëž˜ **Test** ë²„íŠ¼ì„ ëˆŒëŸ¬ `Successfully queried...` ì´ˆë¡ìƒ‰ ë©”ì‹œì§€ê°€ ëœ¨ë©´ ì¤€ë¹„ ì™„ë£Œ!

---

## 2. í•„ìˆ˜ ê´€ì œ ëŒ€ì‹œë³´ë“œ ë§Œë“¤ê¸° (ì‹¤ìŠµ)

ì´ë¯¸ ë§Œë“¤ì–´ì§„ ë³µìž¡í•œ ëŒ€ì‹œë³´ë“œë³´ë‹¤, ìš°ë¦¬ê°€ ë³´ê³  ì‹¶ì€ í•µì‹¬ ì§€í‘œ 3ê°€ì§€ë§Œ ë”± ê³¨ë¼ì„œ ë§Œë“¤ê² ìŠµë‹ˆë‹¤. ë”°ë¼ í•´ë³´ì„¸ìš”!

**íŒ¨ë„ ìƒì„± ë°©ë²•**:
1. ì™¼ìª½ ë©”ë‰´ **Dashboards** (ë„¤ëª¨ ì•„ì´ì½˜) -> **New** -> **New Dashboard**.
2. **+ Add visualization** í´ë¦­.
3. `Prometheus` ì„ íƒ.

### ðŸ“ˆ íŒ¨ë„ 1: "ì£¼ë¬¸ì´ ë“¤ì–´ì˜¤ê³  ìžˆë‚˜?" (HTTP ìš”ì²­ ìˆ˜)
ì‚¬ìš©ìžê°€ ì£¼ë¬¸ ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ ê·¸ëž˜í”„ê°€ íŠ€ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

1. **Metrics browser** ìž…ë ¥ì°½ì— ë‹¤ìŒ ì¿¼ë¦¬ ìž…ë ¥:
   ```promql
   # 1ë¶„ë‹¹ HTTP ìš”ì²­ ìˆ˜ì˜ ë³€í™”ìœ¨ (rate)
   rate(http_server_requests_seconds_count{uri="/api/orders", method="POST"}[1m]) * 60
   ```
2. **Run queries** í´ë¦­.
3. ì˜¤ë¥¸ìª½ ì˜µì…˜ íŒ¨ë„:
   - **Title**: `ì£¼ë¬¸ ìš”ì²­ëŸ‰ (ë¶„ë‹¹)`
   - **Graph styles**: `Bar` (ë§‰ëŒ€ ê·¸ëž˜í”„ ì¶”ì²œ)
4. **Apply** í´ë¦­.

### ðŸ“ˆ íŒ¨ë„ 2: "ë©”ì‹œì§€ê°€ íì— ìŒ“ì´ë‚˜?" (Kafka ì ì²´ëŸ‰)
ì£¼ë¬¸ ì„œë¹„ìŠ¤ê°€ ì œë•Œ ì²˜ë¦¬í•˜ì§€ ëª»í•˜ê³  íì— ë©”ì‹œì§€ê°€ ìŒ“ì´ëŠ”ì§€ ê°ì‹œí•©ë‹ˆë‹¤. `Lag(ì§€ì—°)`ì€ ê°€ìž¥ ì¤‘ìš”í•œ ì§€í‘œìž…ë‹ˆë‹¤.

1. **Metrics browser** ìž…ë ¥ì°½ì— ë‹¤ìŒ ì¿¼ë¦¬ ìž…ë ¥:
   ```promql
   # í˜„ìž¬ ì»¨ìŠˆë¨¸ ê·¸ë£¹(ì£¼ë¬¸ ì²˜ë¦¬ë°˜)ì˜ ì²˜ë¦¬ ì§€ì—° ê°œìˆ˜
   kafka_consumergroup_lag{topic="order-created"}
   ```
   > *ì°¸ê³ : Kafka Exporterê°€ ì„¤ì¹˜ë˜ì–´ ìžˆì–´ì•¼ ì •í™•ížˆ ë³´ìž…ë‹ˆë‹¤. ë§Œì•½ ì•ˆ ë³´ì¸ë‹¤ë©´ ì•„ëž˜ì˜ 'JVM ë©”ëª¨ë¦¬'ë¡œ ëŒ€ì²´í•˜ì„¸ìš”.*
   
   **(ëŒ€ì²´) JVM ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰**:
   ```promql
   # ê° ì„œë¹„ìŠ¤ë³„ íž™ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
   sum(jvm_memory_used_bytes{area="heap"}) by (application)
   ```

### ðŸ“ˆ íŒ¨ë„ 3: "ì„œë²„ê°€ íž˜ë“ ê°€?" (CPU ì‚¬ìš©ëŸ‰)
íŠ¹ì • ì„œë¹„ìŠ¤ê°€ CPUë¥¼ ë§Žì´ ë¨¹ê³  ìžˆì§€ ì•Šì€ì§€ í™•ì¸í•©ë‹ˆë‹¤.

1. **Metrics browser** ìž…ë ¥ì°½ì— ë‹¤ìŒ ì¿¼ë¦¬ ìž…ë ¥:
   ```promql
   # ê° ì»¨í…Œì´ë„ˆì˜ CPU ì‚¬ìš©ëŸ‰ (ì½”ì–´ ë‹¨ìœ„)
   rate(container_cpu_usage_seconds_total{namespace="metacoding", image!=""}[1m])
   ```

2. ì˜¤ë¥¸ìª½ **Legend** (ë²”ë¡€) ì„¤ì •: `{{pod}}` ìž…ë ¥ (ê·¸ëž˜í”„ ì„ ì´ ì–´ë–¤ íŒŒë“œì¸ì§€ ì´ë¦„ í‘œì‹œ).
3. **Apply** í´ë¦­.

---

## 3. ì‹œë‚˜ë¦¬ì˜¤ë³„ ëª¨ë‹ˆí„°ë§ ì‹¤ìŠµ ê°€ì´ë“œ

ì´ì œ ì°½ì„ ë‘ ê°œ ë„ìš°ê³  í…ŒìŠ¤íŠ¸ë¥¼ ì‹œìž‘í•©ë‹ˆë‹¤.
*   **ì°½ 1**: ìš°ë¦¬ ì›¹ ì‚¬ì´íŠ¸ (ì£¼ë¬¸ í™”ë©´)
*   **ì°½ 2**: ë°©ê¸ˆ ë§Œë“  Grafana ëŒ€ì‹œë³´ë“œ (ìš°ì¸¡ ìƒë‹¨ `Refresh` ê°„ê²©ì„ `5s`ë¡œ ì„¤ì •)

### âœ… ì‹œë‚˜ë¦¬ì˜¤ 1: ë¡œê·¸ì¸ ë¶€í•˜ í…ŒìŠ¤íŠ¸
**ëª©í‘œ**: User ì„œë¹„ìŠ¤ê°€ ì¼ì„ í•˜ëŠ”ì§€ ê·¸ëž˜í”„ë¡œ í™•ì¸í•˜ê¸°.

1. ì›¹ì—ì„œ ë¡œê·¸ì¸ì„ **ë¹ ë¥´ê²Œ 5ë²ˆ ì—°ì†**ìœ¼ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.
2. Grafanaì˜ **HTTP ìš”ì²­ ê·¸ëž˜í”„(íŒ¨ë„1)**ì—ì„œ `/login` (ì¿¼ë¦¬ ë³€ê²½ í•„ìš”) í˜¹ì€ ì „ì²´ íŠ¸ëž˜í”½ì´ `íˆ­ íŠ€ì–´ì˜¤ë¥´ëŠ”ì§€` í™•ì¸í•©ë‹ˆë‹¤.
3. **CPU ê·¸ëž˜í”„(íŒ¨ë„3)**ì—ì„œ `user-service-xxx` íŒŒë“œì˜ ì„ ì´ ì‚´ì§ ì˜¬ë¼ê°€ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
   - *"ì•„, ë‚´ê°€ ë¡œê·¸ì¸ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì´ íŒŒë“œê°€ ì¼ì„ í•˜ëŠ”êµ¬ë‚˜!"*

### âœ… ì‹œë‚˜ë¦¬ì˜¤ 2: ì£¼ë¬¸ í­ì£¼ì™€ Kafka íë¦„
**ëª©í‘œ**: ì£¼ë¬¸ -> Kafka -> ë°°ë‹¬ ì„œë¹„ìŠ¤ë¡œ ì´ì–´ì§€ëŠ” íë¦„ ë³´ê¸°.

1. ì›¹ì—ì„œ **[ì£¼ë¬¸ ìš”ì²­í•˜ê¸°]** ë²„íŠ¼ì„ ëˆ„ë¦…ë‹ˆë‹¤.
2. **HTTP íŒ¨ë„**: `/api/orders` ìš”ì²­ ë§‰ëŒ€ê·¸ëž˜í”„ê°€ í•˜ë‚˜ ì†ŸìŠµë‹ˆë‹¤. (ì£¼ë¬¸ ì ‘ìˆ˜)
3. **ë©”ëª¨ë¦¬/CPU íŒ¨ë„**:
   - ì²˜ìŒì—” `order-service`ê°€ ì›€ì§ìž…ë‹ˆë‹¤. (ì£¼ë¬¸ ì €ìž¥)
   - 1~2ì´ˆ ë’¤ `delivery-service`ê°€ ì›€ì§ìž…ë‹ˆë‹¤. (Kafka ë©”ì‹œì§€ ìˆ˜ì‹  í›„ ë°°ë‹¬ ìƒì„±)
   - *"ë‘ ì„œë¹„ìŠ¤ê°€ ì‹œì°¨ë¥¼ ë‘ê³  ë°˜ì‘í•˜ëŠ” ê²ƒ"*ì´ ë°”ë¡œ **ë¹„ë™ê¸° ì²˜ë¦¬(Kafka)**ì˜ ì¦ê±°ìž…ë‹ˆë‹¤!

### âœ… ì‹œë‚˜ë¦¬ì˜¤ 3: ë°°ë‹¬ ì™„ë£Œ
1. í¬ìŠ¤íŠ¸ë§¨ìœ¼ë¡œ ë°°ë‹¬ ì™„ë£Œ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
2. **CPU íŒ¨ë„**ì—ì„œ `orchestrator-service`ê°€ ê°‘ìžê¸° íŠ€ì–´ì˜¤ë¥´ëŠ”ì§€ ë´…ë‹ˆë‹¤.
   - ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ê°€ "ë°°ë‹¬ ëë‚¬ìœ¼ë‹ˆ ì£¼ë¬¸ë„ ëë‚´ë¼!" í•˜ê³  ë§ˆë¬´ë¦¬ ìž‘ì—…ì„ í•˜ê¸° ë•Œë¬¸ìž…ë‹ˆë‹¤.

---

## 4. ë¬¸ì œ í•´ê²° (Troubleshooting)

**Q. ê·¸ëž˜í”„ì— ë°ì´í„°ê°€ ì•ˆ ë‚˜ì™€ìš”!**
1. **ì‹œê°„ ë²”ìœ„ í™•ì¸**: ìš°ì¸¡ ìƒë‹¨ ì‹œê³„ ì•„ì´ì½˜ì´ `Last 15 minutes` ì •ë„ë¡œ ë˜ì–´ ìžˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
2. **íŒŒë“œ ì„¤ì • í™•ì¸**: `prometheus.io/scrape: "true"` ì„¤ì •ì´ ê° Deployment yamlì— ìž˜ ë“¤ì–´ìžˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
3. **íŠ¸ëž˜í”½ ë¶€ì¡±**: ì•„ë¬´ë„ ì ‘ì† ì•ˆ í•˜ë©´ ê·¸ëž˜í”„ëŠ” 0ìž…ë‹ˆë‹¤. ì›¹ì—ì„œ ë²„íŠ¼ì„ ë§ˆêµ¬ ëˆŒëŸ¬ë³´ì„¸ìš”.

**Q. ì¿¼ë¦¬ ì§œëŠ” ê²Œ ë„ˆë¬´ ì–´ë ¤ì›Œìš”.**
*   [Spring Boot 2.1 System Monitor](https://grafana.com/grafana/dashboards/11378-justai-system-monitor/) ê°™ì€ **ê³µê°œ ëŒ€ì‹œë³´ë“œ**ë¥¼ Importí•´ì„œ ì“°ëŠ” ê²Œ ì •ì„ìž…ë‹ˆë‹¤.
    *   Grafana -> Dashboards -> New -> Import -> ID `11378` ìž…ë ¥ -> Load.
    *   ì´ë ‡ê²Œ í•˜ë©´ ì „ë¬¸ê°€ê°€ ë§Œë“  ë©‹ì§„ ëŒ€ì‹œë³´ë“œê°€ í•œë²ˆì— ìƒê¹ë‹ˆë‹¤!

## Mermaid ë‹¤ì´ì–´ê·¸ëž¨

### Flow

```mermaid
flowchart LR
  App[Services] --> P[Prometheus]
  P --> G[Grafana]
  G --> U[User]
```

### Sequence

```mermaid
sequenceDiagram
  participant U as User
  participant K as kubectl
  participant G as Grafana
  participant P as Prometheus

  U->>K: port-forward grafana
  U->>G: Open UI
  G->>P: Query Metrics
  P-->>G: Metrics
  G-->>U: Dashboard
```

