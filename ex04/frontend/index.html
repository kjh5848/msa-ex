<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
  <h1>고객 화면</h1>

  <button onclick="createOrder()">주문하기</button>

  <h3 id="status"></h3>

  <script>
    // 2026년까지 유효한 토큰 (userId: 1)
    const TOKEN = "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJzc2FyIiwiZXhwIjoxNzY5OTU5OTk3fQ.R8sOgjI46gaaJ-df--LuxP-ISEFF9lfOxko8QLd558gsMt-uf7NE3sAeGIAvydESe0Uu-IKaTXFqi3CCgfAotw";
    const status = document.getElementById('status');
    let stomp = null;

    async function createOrder() {
      // 1. 연결 및 구독 (주문 전에 미리 귀를 열어둠)
      if (!stomp || !stomp.connected) {
        status.textContent = "서버 연결 중...";
        stomp = Stomp.over(new SockJS(`/api/ws/orders?token=${TOKEN}`));
        
        await new Promise((resolve, reject) => {
            stomp.connect({}, () => {
                // 연결 성공하자마자 바로 구독! (userId: 1 하드코딩 또는 토큰에서 추출)
                const userId = 1; 
                stomp.subscribe(`/topic/orders/${userId}`, (msg) => {
                    const data = JSON.parse(msg.body);
                    status.textContent = `주문이 완료되었습니다. (주문번호: ${data.orderId})`;
                    console.log("알림 수신:", data);
                });
                console.log("✅ 연결 및 구독 완료");
                resolve();
            }, reject);
        });
      }

      try {
        status.textContent = "주문 요청 중...";

        const response = await fetch('/api/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${TOKEN}`
          },
          body: JSON.stringify({
            productId: 1,
            quantity: 1,
            price: 25000,
            address: "Addr 4"
          })
        });

        if (response.ok) {
          const data = await response.json();
          // 여기서 또 구독할 필요 없음 (이미 위에서 구독 중)
          status.innerHTML = `서버 응답 성공! (Order ID: ${data.body.id})<br>배달 완료 알림을 기다리는 중...`;
        } else {
          status.textContent = "주문 요청 실패";
        }
    } catch (error) {
      status.textContent = "오류 발생: " + error;
      console.error(error);
    }
  }
</script>
</body>
</html>
